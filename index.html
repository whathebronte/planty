<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planty ‚Äî Plant Watering Tracker</title>

<!-- ============================================================
     FIREBASE CONFIGURATION
     Replace the firebaseConfig object below with your own
     Firebase project config. You can find it in the Firebase
     Console under Project Settings > General > Your Apps.
     ============================================================ -->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;1,9..144,300;1,9..144,400&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">

<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --white: #FFFFFF;
  --gray-bg: #F7F7F7;
  --gray-100: #EBEBEB;
  --gray-200: #DDDDDD;
  --gray-300: #B0B0B0;
  --gray-400: #717171;
  --gray-500: #484848;
  --gray-600: #222222;
  --accent: #3eb489;
  --accent-hover: #35a07a;
  --accent-light: #eaf7f1;
  --icon-bg: #f4fbf7;
  --water-btn-bg: #eef7ff;
  --water-btn-hover: #d8eeff;
  --green: #3eb489;
  --yellow: #E8A317;
  --red: #E04848;
  --gray-status: #B0B0B0;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
  --radius: 14px;
  --radius-sm: 10px;
  --radius-pill: 50px;
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --font-display: 'Fraunces', Georgia, 'Times New Roman', serif;
}

html {
  font-family: var(--font);
  color: var(--gray-600);
  background: var(--gray-bg);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  min-height: 100vh;
  padding-bottom: 80px;
}

/* App header */
.app-header {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 600;
  color: #1a1a1a;
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
}

/* Error banner */
.error-banner {
  background: #FEF2F2;
  color: var(--red);
  text-align: center;
  padding: 10px 24px;
  font-size: 14px;
  font-weight: 500;
  display: none;
}

.error-banner.visible {
  display: block;
}

/* Main container */
.container {
  max-width: 600px;
  margin: 0 auto;
  padding: 24px 16px;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 60px 24px;
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-top: 8px;
}

.empty-state .emoji {
  font-size: 72px;
  display: block;
  margin-bottom: 16px;
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
}

.empty-state h2 {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 15px;
  color: var(--gray-400);
  margin-bottom: 24px;
}

/* Skeleton loader */
.skeleton-row {
  background: var(--white);
  border-radius: var(--radius-sm);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-left: 4px solid var(--gray-100);
}

.skeleton-line {
  background: var(--gray-100);
  border-radius: 8px;
  animation: pulse 1.5s ease-in-out infinite;
}

.skeleton-line.icon {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  flex-shrink: 0;
}

.skeleton-line.title {
  width: 40%;
  height: 16px;
  flex-shrink: 0;
}

.skeleton-line.subtitle {
  width: 20%;
  height: 12px;
  margin-left: auto;
}

.skeleton-line.button {
  width: 70px;
  height: 32px;
  border-radius: var(--radius-pill);
  flex-shrink: 0;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Plant list */
.plant-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Water All button */
.water-all-btn {
  width: 100%;
  padding: 14px 20px;
  background: transparent;
  color: var(--accent);
  border: 1.5px solid var(--accent);
  border-radius: var(--radius);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.01em;
  cursor: pointer;
  transition: background 0.18s ease, color 0.18s ease;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.water-all-btn:hover {
  background: var(--accent);
  color: #FFFFFF;
}

.water-all-btn:active {
  transform: scale(0.98);
  background: var(--accent-hover);
  color: #FFFFFF;
}

/* Plant cards */
.plant-card {
  border-radius: var(--radius);
  border: 1px solid #f0f0f0;
  overflow: hidden;
  background: var(--white);
  transition: box-shadow 0.2s ease;
}

.plant-card.open {
  box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  border-color: #e8e8e8;
}

.card-row {
  display: flex;
  align-items: center;
  gap: 13px;
  padding: 13px 14px;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}

.plant-icon {
  font-size: 26px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--icon-bg);
  border-radius: 12px;
  flex-shrink: 0;
}

.plant-info {
  flex: 1;
  min-width: 0;
}

.plant-name {
  font-family: var(--font-display);
  font-size: 15px;
  font-weight: 400;
  color: #1a1a1a;
  letter-spacing: -0.01em;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

.badge {
  font-family: var(--font);
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 20px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  white-space: nowrap;
  flex-shrink: 0;
}

.plant-status {
  font-family: var(--font);
  font-size: 12px;
  margin-top: 3px;
  font-weight: 500;
}

.water-circle {
  width: 40px;
  height: 40px;
  background: var(--water-btn-bg);
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 17px;
  flex-shrink: 0;
  cursor: pointer;
  transition: background 0.15s;
  padding: 0;
}

.water-circle:hover {
  background: var(--water-btn-hover);
}

.water-circle:active {
  transform: scale(0.85);
}

.chevron {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  color: #ccc;
  transition: transform 0.22s ease, color 0.22s ease;
}

.plant-card.open .chevron {
  transform: rotate(180deg);
  color: var(--accent);
}

/* Expanded panel */
.expand-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.28s ease;
  background: #fafafa;
  border-top: 1px solid transparent;
}

.plant-card.open .expand-panel {
  max-height: 520px;
  border-top-color: #f0f0f0;
}

.expand-inner {
  padding: 16px 14px 18px;
}

.expand-title {
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 600;
  color: #888;
  letter-spacing: 0.01em;
  margin-bottom: 10px;
  font-style: italic;
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 14px;
}

.detail-item {
  background: var(--white);
  border-radius: 10px;
  border: 1px solid #ebebeb;
  padding: 10px 12px;
}

.detail-label {
  font-family: var(--font);
  font-size: 10px;
  font-weight: 600;
  color: #bbb;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 3px;
}

.detail-value {
  font-family: var(--font-display);
  font-size: 15px;
  font-weight: 400;
  color: #1a1a1a;
}

.detail-value.green {
  color: var(--accent);
}

.care-note {
  font-family: var(--font);
  font-size: 12px;
  color: #999;
  line-height: 1.6;
  border-top: 1px solid #ebebeb;
  padding-top: 12px;
  margin-top: 4px;
}

.care-note strong {
  font-weight: 600;
  color: #666;
}

.expand-actions {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #ebebeb;
}

.expand-rec {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--gray-400);
  flex: 1;
  flex-wrap: wrap;
}

.expand-edit-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--gray-300);
  font-size: 12px;
  font-family: var(--font);
  font-weight: 500;
  padding: 2px 6px;
  border-radius: 4px;
  transition: color 0.2s;
}

.expand-edit-btn:hover {
  color: var(--accent);
}

.reset-link {
  color: var(--accent);
  cursor: pointer;
  font-size: 12px;
  text-decoration: underline;
  background: none;
  border: none;
  padding: 0;
  font-family: var(--font);
}

.reset-link:hover {
  color: var(--accent-hover);
}

.plant-delete {
  background: none;
  border: none;
  color: var(--gray-300);
  cursor: pointer;
  padding: 4px 8px;
  font-size: 12px;
  font-weight: 500;
  font-family: var(--font);
  border-radius: 6px;
  transition: color 0.2s, background 0.2s;
  margin-left: auto;
}

.plant-delete:hover {
  color: var(--red);
  background: #FEF2F2;
}

/* Inline interval editor */
.interval-editor {
  display: none;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--gray-400);
}

.interval-editor.active {
  display: flex;
}

.interval-editor input {
  width: 60px;
  padding: 6px 10px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  outline: none;
  transition: border-color 0.2s;
}

.interval-editor input:focus {
  border-color: var(--accent);
}

.interval-editor .save-btn,
.interval-editor .cancel-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 13px;
  font-family: var(--font);
  font-weight: 500;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background 0.2s;
}

.interval-editor .save-btn {
  color: var(--accent);
}

.interval-editor .save-btn:hover {
  background: var(--accent-light);
}

.interval-editor .cancel-btn {
  color: var(--gray-400);
}

.interval-editor .cancel-btn:hover {
  background: var(--gray-bg);
}

/* Add plant button */
.add-plant-btn {
  width: 100%;
  padding: 13px;
  background: transparent;
  border: 1.5px dashed var(--gray-200);
  border-radius: var(--radius);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-300);
  cursor: pointer;
  transition: border-color 0.15s, color 0.15s;
  margin-top: 6px;
}

.add-plant-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* Modal overlay */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: flex-end;
  justify-content: center;
}

.modal-overlay.visible {
  display: flex;
}

.modal {
  background: var(--white);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 600px;
  padding: 32px 24px;
  max-height: 85vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease-out;
}

@media (min-width: 601px) {
  .modal-overlay.visible {
    align-items: center;
  }
  .modal {
    border-radius: var(--radius);
    max-height: 80vh;
  }
}

@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.modal-header h2 {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--gray-400);
  cursor: pointer;
  padding: 4px;
  line-height: 1;
  border-radius: 8px;
}

.modal-close:hover {
  background: var(--gray-bg);
}

/* Form */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-500);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.form-group input[type="text"] {
  width: 100%;
  padding: 14px 16px;
  border: 1.5px solid var(--gray-200);
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
}

.form-group input[type="text"]:focus {
  border-color: var(--accent);
}

/* Autocomplete */
.autocomplete-wrapper {
  position: relative;
}

.autocomplete-list {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--white);
  border: 1.5px solid var(--gray-200);
  border-top: none;
  border-radius: 0 0 var(--radius-sm) var(--radius-sm);
  max-height: 200px;
  overflow-y: auto;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.autocomplete-list.visible {
  display: block;
}

.autocomplete-item {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.15s;
}

.autocomplete-item:hover,
.autocomplete-item.highlighted {
  background: var(--accent-light);
}

.autocomplete-item .ac-emoji {
  font-size: 20px;
}

.autocomplete-item .ac-name {
  font-weight: 500;
}

.autocomplete-item .ac-interval {
  font-size: 12px;
  color: var(--gray-400);
  margin-left: auto;
}

/* Toggle */
.toggle-group {
  display: flex;
  background: var(--gray-bg);
  border-radius: var(--radius-sm);
  padding: 4px;
  gap: 4px;
}

.toggle-option {
  flex: 1;
  padding: 12px;
  text-align: center;
  font-family: var(--font);
  font-size: 14px;
  font-weight: 500;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: var(--gray-400);
  background: transparent;
  transition: all 0.2s;
}

.toggle-option.active {
  background: var(--white);
  color: var(--gray-600);
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  font-weight: 600;
}

.submit-btn {
  width: 100%;
  padding: 16px;
  background: var(--accent);
  color: var(--white);
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
  margin-top: 8px;
}

.submit-btn:hover {
  background: var(--accent-hover);
}

.submit-btn:disabled {
  background: var(--gray-200);
  color: var(--gray-300);
  cursor: not-allowed;
}

/* Confirm dialog */
.confirm-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 300;
  align-items: center;
  justify-content: center;
}

.confirm-overlay.visible {
  display: flex;
}

.confirm-box {
  background: var(--white);
  border-radius: var(--radius);
  padding: 28px 24px;
  max-width: 340px;
  width: calc(100% - 32px);
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.confirm-box h3 {
  font-family: var(--font-display);
  font-size: 17px;
  font-weight: 600;
  margin-bottom: 8px;
}

.confirm-box p {
  font-size: 14px;
  color: var(--gray-400);
  margin-bottom: 20px;
}

.confirm-actions {
  display: flex;
  gap: 10px;
}

.confirm-actions button {
  flex: 1;
  padding: 12px;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: background 0.2s;
}

.confirm-cancel {
  background: var(--gray-bg);
  color: var(--gray-500);
}

.confirm-cancel:hover {
  background: var(--gray-100);
}

.confirm-delete {
  background: var(--red);
  color: var(--white);
}

.confirm-delete:hover {
  background: #c93d3d;
}

/* Undo toast */
.undo-toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--white);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-lg);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  z-index: 400;
  max-width: calc(100% - 32px);
  width: 360px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s, transform 0.25s;
  transform: translateX(-50%) translateY(16px);
  overflow: hidden;
}

.undo-toast.visible {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(-50%) translateY(0);
}

.undo-toast-text {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-600);
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.undo-toast-btn {
  background: none;
  border: none;
  color: var(--accent);
  font-family: var(--font);
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  flex-shrink: 0;
  transition: background 0.2s;
}

.undo-toast-btn:hover {
  background: var(--accent-light);
}

.undo-toast-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: var(--accent);
  width: 100%;
  transform-origin: left;
  animation: none;
}

.undo-toast.visible .undo-toast-bar {
  animation: shrinkBar 5s linear forwards;
}

@keyframes shrinkBar {
  from { transform: scaleX(1); }
  to { transform: scaleX(0); }
}

/* Responsive */
@media (max-width: 640px) {
  .container {
    padding: 16px 12px;
  }
}
</style>
</head>
<body>

<div class="error-banner" id="errorBanner">
  Couldn't connect ‚Äî your changes may not be saved. Retrying&hellip;
</div>

<div class="container">
  <div class="app-header">ü™¥ Planty</div>
  <div id="app">
    <!-- Content injected by JS -->
  </div>
</div>

<!-- Add Plant Modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Add a Plant</h2>
      <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
    </div>
    <div class="form-group">
      <label for="plantName">Plant Name</label>
      <div class="autocomplete-wrapper">
        <input type="text" id="plantName" placeholder="e.g. Monstera, Basil, Cactus..." autocomplete="off">
        <div class="autocomplete-list" id="autocompleteList"></div>
      </div>
    </div>
    <div class="form-group">
      <label>Environment</label>
      <div class="toggle-group">
        <button class="toggle-option active" data-env="indoor" id="toggleIndoor">&#127968; Indoor</button>
        <button class="toggle-option" data-env="outdoor" id="toggleOutdoor">&#9728;&#65039; Outdoor</button>
      </div>
    </div>
    <button class="submit-btn" id="addPlantSubmit" disabled>Add Plant</button>
  </div>
</div>

<!-- Confirm Delete Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>Remove plant?</h3>
    <p id="confirmText">This will permanently remove this plant.</p>
    <div class="confirm-actions">
      <button class="confirm-cancel" id="confirmCancel">Cancel</button>
      <button class="confirm-delete" id="confirmDelete">Remove</button>
    </div>
  </div>
</div>

<!-- Undo Toast -->
<div class="undo-toast" id="undoToast">
  <span class="undo-toast-text" id="undoToastText"></span>
  <button class="undo-toast-btn" id="undoToastBtn">Undo</button>
  <div class="undo-toast-bar" id="undoToastBar"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// ============================================================
// FIREBASE CONFIGURATION ‚Äî Paste your config here
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyBhn8bPhA0rNxIp6MBLTS6XHFvbdPE7tfU",
  authDomain: "planty-441e8.firebaseapp.com",
  projectId: "planty-441e8",
  storageBucket: "planty-441e8.firebasestorage.app",
  messagingSenderId: "574753287039",
  appId: "1:574753287039:web:16c5e8a65211e87338c84a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ============================================================
// Plant Database (50 common plants)
// ============================================================
const PLANT_DATABASE = [
  { name: "Pothos", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Low‚Äìbright", tip: "Tolerates low light but grows faster in bright indirect light; trim long vines to keep it bushy." },
  { name: "Snake Plant", indoor: [14, 21], outdoor: [10, 14], emoji: "\ud83c\udf3f", light: "Low‚Äìindirect", tip: "One of the toughest plants around‚Äîthrives on neglect and tolerates almost any light level." },
  { name: "Monstera", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Indirect", tip: "Monsteras love humidity; mist the leaves weekly or place on a pebble tray with water nearby." },
  { name: "Fiddle Leaf Fig", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf33", light: "Bright indirect", tip: "Keep in a stable spot‚Äîfiddle leaf figs are sensitive to being moved and dislike drafts." },
  { name: "Peace Lily", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf38", light: "Low‚Äìmedium", tip: "Drooping leaves are a reliable thirst signal; it will perk back up quickly after watering." },
  { name: "Spider Plant", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Indirect", tip: "A great air purifier; let soil dry between waterings to prevent root rot." },
  { name: "Rubber Plant", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "Wipe leaves with a damp cloth monthly to keep them glossy and help the plant breathe." },
  { name: "ZZ Plant", indoor: [14, 21], outdoor: [10, 14], emoji: "\ud83c\udf3f", light: "Low‚Äìbright", tip: "Nearly indestructible‚Äîit stores water in its rhizomes, so underwatering is far safer than overwatering." },
  { name: "Philodendron", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Indirect", tip: "Fast grower in bright indirect light; let the top inch of soil dry out between waterings." },
  { name: "Calathea", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Medium indirect", tip: "Use filtered or distilled water‚Äîtap water minerals cause the leaf tips to turn brown." },
  { name: "Dracaena", indoor: [10, 14], outdoor: [7, 10], emoji: "\ud83c\udf3f", light: "Low‚Äìmedium", tip: "Sensitive to fluoride; use filtered or rainwater when possible to prevent leaf tip burn." },
  { name: "Chinese Evergreen", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Low‚Äìindirect", tip: "One of the easiest plants for dim spaces; avoid direct sun which will scorch the leaves." },
  { name: "Bird of Paradise", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3a", light: "Bright indirect", tip: "Needs several hours of bright light daily indoors; wipe large leaves to remove dust." },
  { name: "Dieffenbachia", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Medium indirect", tip: "Toxic if ingested‚Äîkeep away from children and pets and wash hands after handling." },
  { name: "Croton", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright direct", tip: "More light equals more vibrant color; place in your sunniest spot for the best foliage display." },
  { name: "Succulent", indoor: [14, 21], outdoor: [7, 10], emoji: "\ud83e\udeb4", light: "Bright sun", tip: "Let soil dry completely between waterings; soggy soil is the fastest way to cause root rot." },
  { name: "Cactus", indoor: [21, 30], outdoor: [14, 21], emoji: "\ud83c\udf35", light: "Bright sun", tip: "Less is more‚Äîoverwatering is the number one cactus killer; when in doubt, wait longer." },
  { name: "Aloe Vera", indoor: [14, 21], outdoor: [7, 14], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "Let the soil dry out fully between waterings; aloe stores water in its leaves so it's very drought tolerant." },
  { name: "Jade Plant", indoor: [14, 21], outdoor: [7, 14], emoji: "\ud83e\udeb4", light: "Bright indirect", tip: "Feed lightly in spring and summer only; with good care jade plants can live for decades." },
  { name: "Echeveria", indoor: [14, 21], outdoor: [7, 10], emoji: "\ud83e\udeb4", light: "Bright sun", tip: "Rotate the pot regularly so all sides get even light; etiolation (stretching) means it needs more sun." },
  { name: "Haworthia", indoor: [14, 21], outdoor: [7, 14], emoji: "\ud83e\udeb4", light: "Indirect", tip: "One of the few succulents that genuinely tolerates lower light‚Äîperfect for windowsill shade." },
  { name: "String of Pearls", indoor: [10, 14], outdoor: [7, 10], emoji: "\ud83e\udeb4", light: "Bright indirect", tip: "Water from the base when possible to prevent rot on the delicate trailing stems." },
  { name: "Burro's Tail", indoor: [14, 21], outdoor: [7, 14], emoji: "\ud83e\udeb4", light: "Bright indirect", tip: "Leaves fall off at the slightest touch‚Äîplace somewhere it won't be disturbed once settled." },
  { name: "Fern", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf3f", light: "Indirect", tip: "Keep soil consistently moist and mist regularly; ferns hate drying out and love humidity." },
  { name: "Boston Fern", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf3f", light: "Indirect", tip: "High humidity is key; set on a pebble tray or grow in a bathroom for best results." },
  { name: "Maidenhair Fern", indoor: [2, 3], outdoor: [1, 2], emoji: "\ud83c\udf3f", light: "Medium indirect", tip: "The most demanding fern‚Äîneeds consistently moist soil, high humidity, and no cold drafts." },
  { name: "Bird's Nest Fern", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Low‚Äìmedium", tip: "Never pour water into the central rosette; always water at the base to prevent crown rot." },
  { name: "Orchid", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf38", light: "Bright indirect", tip: "Roots need airflow; clear pots let you check moisture levels without disturbing the plant." },
  { name: "African Violet", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf38", light: "Medium indirect", tip: "Water from the base to avoid water spots on the fuzzy leaves, which cause permanent marks." },
  { name: "Anthurium", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3a", light: "Bright indirect", tip: "The waxy blooms last for months; wipe glossy leaves with a damp cloth to keep them dust-free." },
  { name: "Begonia", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf38", light: "Bright indirect", tip: "Let the top inch of soil dry between waterings; begonias are prone to root rot if kept too wet." },
  { name: "Basil", indoor: [2, 3], outdoor: [1, 2], emoji: "\ud83c\udf31", light: "Full sun", tip: "Pinch off flower buds as soon as they appear to encourage leafy, bushy growth." },
  { name: "Mint", indoor: [2, 3], outdoor: [1, 2], emoji: "\ud83c\udf31", light: "Full sun", tip: "Grow mint in its own container‚Äîit spreads aggressively via runners and will crowd out other plants." },
  { name: "Rosemary", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf31", light: "Full sun", tip: "Prefers slightly dry conditions; great drainage matters more than frequent watering." },
  { name: "Lavender", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83d\udc9c", light: "Full sun", tip: "Needs excellent drainage and full sun; lavender is very drought-tolerant once established." },
  { name: "Thyme", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf31", light: "Full sun", tip: "Drought-tolerant herb; water deeply but infrequently and ensure good air circulation." },
  { name: "Cilantro", indoor: [2, 3], outdoor: [1, 2], emoji: "\ud83c\udf31", light: "Full sun", tip: "Bolts quickly in heat; sow in spring or fall for the best leaf production before it flowers." },
  { name: "Parsley", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf31", light: "Full sun", tip: "Slow to germinate but vigorous once established; harvest outer stems to encourage new growth." },
  { name: "Oregano", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf31", light: "Full sun", tip: "Flavor intensifies when slightly stressed‚Äîavoid over-watering or over-fertilizing for best taste." },
  { name: "Chives", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf31", light: "Full sun", tip: "Snip regularly to encourage fresh growth; the purple flowers are edible and look beautiful." },
  { name: "Sage", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf31", light: "Full sun", tip: "Drought-tolerant once established; sandy, well-drained soil is ideal to prevent root rot." },
  { name: "Tomato", indoor: [2, 3], outdoor: [1, 2], emoji: "\ud83c\udf45", light: "Full sun", tip: "Needs at least 8 hours of direct sun and consistent moisture for good fruit set and flavor." },
  { name: "Pepper", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf36\ufe0f", light: "Full sun", tip: "Loves heat; use dark-colored pots outdoors to warm the root zone and speed up growth." },
  { name: "Strawberry", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf53", light: "Full sun", tip: "Runners that form after fruiting can be potted up to create new plants for free next season." },
  { name: "Lettuce", indoor: [2, 3], outdoor: [1, 2], emoji: "\ud83e\udd6c", light: "Partial sun", tip: "Harvest outer leaves regularly rather than cutting the whole plant to extend the growing season." },
  { name: "Parlor Palm", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf34", light: "Low‚Äìmedium", tip: "Great beginner palm‚Äîtolerates low light and irregular watering better than most palms." },
  { name: "Areca Palm", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf34", light: "Bright indirect", tip: "A natural humidifier that transpires a lot of moisture; great for dry indoor spaces." },
  { name: "Ponytail Palm", indoor: [14, 21], outdoor: [7, 14], emoji: "\ud83c\udf34", light: "Bright sun", tip: "Stores water in its swollen trunk‚Äîone of the most drought-tolerant plants you can own." },
  { name: "Money Tree", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf33", light: "Indirect", tip: "Rotate weekly for even growth; the braided trunk makes it a striking focal point in any room." },
  { name: "Umbrella Plant", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "Prune regularly to keep it bushy; yellowing and dropping leaves signal overwatering." },

  // Singapore & tropical houseplants
  { name: "Ginseng Ficus", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf33", light: "Bright indirect", tip: "A popular bonsai-style fig with swollen aerial roots; mist regularly and avoid cold drafts to keep it happy." },
  { name: "Caladium", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf3a", light: "Bright indirect", tip: "Loves warmth and humidity; keep soil consistently moist and protect from direct sun to preserve its vivid leaf colours." },
  { name: "Alocasia", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "The Elephant Ear thrives in Singapore's humidity; wipe large leaves to remove dust and allow more light absorption." },
  { name: "Hoya", indoor: [10, 14], outdoor: [7, 10], emoji: "\ud83c\udf38", light: "Bright indirect", tip: "A waxy trailing vine that stores water in its leaves; let the top half of the soil dry out between waterings to avoid root rot." },
  { name: "Syngonium", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Low\u2013bright indirect", tip: "The Arrowhead Plant adapts well to Singapore's indoor conditions; pinch back vines to keep it compact and bushy." },
  { name: "Tradescantia", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83d\udc9c", light: "Bright indirect", tip: "Fast-growing and colourful; trim leggy stems to encourage fuller growth and use cuttings to propagate easily in water." },
  { name: "Pandan", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf3e", light: "Full sun\u2013bright indirect", tip: "A kitchen staple in Singapore; keep soil consistently moist and harvest outer leaves first for use in cooking and baking." },
  { name: "Bromeliad", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3a", light: "Bright indirect", tip: "Water into the central cup of leaves and refresh it weekly to prevent stagnation; perfect for Singapore's warm, humid climate." },
  { name: "Lipstick Plant", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf39", light: "Bright indirect", tip: "Produces vivid red tubular flowers; thrives in high humidity and bright light, making it an excellent choice for Singapore homes." },
  { name: "Nerve Plant", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf3f", light: "Low\u2013bright indirect", tip: "Fittonia loves consistent moisture and high humidity; a pebble tray with water underneath helps recreate its rainforest origins." },
  { name: "Lucky Bamboo", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf8b", light: "Low\u2013indirect", tip: "Change the water every 1\u20132 weeks if grown hydroponically; a feng shui favourite that thrives in Singapore's warm indoor conditions." },
  { name: "Prayer Plant", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "Maranta folds its leaves upward at night like praying hands; keep humidity high and soil evenly moist for best colour." },
  { name: "Scindapsus", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Low\u2013bright indirect", tip: "The Silver Pothos has beautiful metallic-marked leaves; an incredibly easy trailing plant that tolerates the low light of Singapore HDB corridors." },
  { name: "Lady Palm", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf34", light: "Low\u2013bright indirect", tip: "Rhapis excelsa is one of the best indoor palms for Singapore; slow-growing but very tolerant of shade and indoor air conditioning." },
  { name: "Air Plant", indoor: [7, 10], outdoor: [5, 7], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "Tillandsia absorbs water through its leaves; soak in water for 20\u201330 minutes weekly and shake off excess to prevent rot." },
  { name: "Bougainvillea", indoor: [7, 10], outdoor: [3, 5], emoji: "\ud83c\udf38", light: "Full sun", tip: "Thrives in Singapore's year-round sun; let the soil dry slightly between waterings to trigger prolific flowering\u2014over-watering reduces blooms." },
  { name: "Heliconia", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3a", light: "Full sun\u2013partial shade", tip: "A stunning tropical native; keep soil moist and feed regularly to encourage its spectacular lobster-claw flower spikes." },
  { name: "Ixora", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3c", light: "Full sun", tip: "A common Singapore garden shrub with vivid clusters of small flowers; prefers acidic soil and regular feeding to maintain lush blooms." },
  { name: "Curry Leaf Plant", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf43", light: "Full sun", tip: "An aromatic kitchen herb popular in Singapore and Indian cooking; needs full sun and well-draining soil, and benefits from regular harvesting." },
  { name: "Ctenanthe", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "A close relative of Calathea with bold striped leaves; keep humidity high and avoid direct sun to prevent leaf edges from browning." },
  { name: "Ti Plant", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright indirect\u2013partial shade", tip: "Cordyline fruticosa adds bold colour to Singapore gardens and interiors; drought-tolerant once established but looks best with regular moisture." },
  { name: "Torch Ginger", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf39", light: "Full sun\u2013partial shade", tip: "Etlingera elatior is a Singapore native with spectacular waxy flower torches used in local cuisine; keep soil moist and fertilise monthly." },
  { name: "Bat Plant", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright indirect\u2013shade", tip: "Tacca chantrieri has dramatic dark flowers with long whisker-like bracts; thrives in Singapore's humidity with consistently moist, well-draining soil." },
  { name: "Bamboo", indoor: [3, 5], outdoor: [2, 3], emoji: "\ud83c\udf8d", light: "Full sun\u2013partial shade", tip: "Grows vigorously in Singapore's climate; use containers to control spreading and water frequently during hot dry spells." },
  { name: "Asparagus Fern", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf3f", light: "Bright indirect", tip: "Not a true fern\u2014its feathery fronds tolerate more drought than ferns; mist regularly in air-conditioned rooms to keep foliage lush." },
  { name: "Spiral Ginger", indoor: [5, 7], outdoor: [3, 5], emoji: "\ud83c\udf00", light: "Partial shade\u2013full sun", tip: "Costus is a beautiful tropical ginger with spiralling stems; water generously in Singapore's heat and divide clumps every few years to rejuvenate." }
];

// ============================================================
// Status Color Palette
// ============================================================
const STATUS_COLORS = {
  fresh:   { text: '#3eb489', badgeBg: '#eaf7f1', label: 'Fresh' },
  close:   { text: '#B89030', badgeBg: '#FBF5E6', label: 'Due soon' },
  due:     { text: '#C06535', badgeBg: '#FAEEE5', label: 'Due today' },
  overdue: { text: '#B54545', badgeBg: '#FBEAEA', label: 'Overdue' },
  never:   { text: '#999999', badgeBg: '#F3F3F3', label: 'Never watered' },
};

// ============================================================
// App State
// ============================================================
let uid = null;
let plants = [];
let isLoading = true;
let deleteTargetId = null;
let selectedEnv = 'indoor';
let highlightedIndex = -1;
let expandedPlantId = null;
let undoToastTimeout = null;
let undoCallback = null;

// ============================================================
// UID Management
// ============================================================
function getUidFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id') || null;
}

function setUidInUrl(newUid) {
  const url = new URL(window.location.href);
  url.searchParams.set('id', newUid);
  window.history.replaceState(null, '', url.toString());
}

function initUid() {
  uid = getUidFromUrl();
  if (!uid) {
    // No UID in URL ‚Äî check localStorage for a returning visitor
    const stored = localStorage.getItem('plantTracker_uid');
    if (stored) {
      uid = stored;
    } else {
      uid = crypto.randomUUID();
    }
    setUidInUrl(uid);
  }
  // Always save the current UID (handles new, stored, or direct-link visits)
  localStorage.setItem('plantTracker_uid', uid);
}

function startFresh() {
  localStorage.removeItem('plantTracker_uid');
  uid = crypto.randomUUID();
  setUidInUrl(uid);
  localStorage.setItem('plantTracker_uid', uid);
  plants = [];
  expandedPlantId = null;
  loadPlants();
}

// ============================================================
// Firestore Operations
// ============================================================
function plantsRef() {
  return db.collection('users').doc(uid).collection('plants');
}

async function loadPlants() {
  isLoading = true;
  render();
  try {
    const snapshot = await plantsRef().orderBy('createdAt', 'asc').get();
    plants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    hideError();
  } catch (err) {
    console.error('Failed to load plants:', err);
    showError();
    retryLoad();
  }
  isLoading = false;
  render();
}

let retryTimeout = null;
let retryCount = 0;

function retryLoad() {
  if (retryCount >= 4) return;
  const delays = [2000, 4000, 8000, 16000];
  retryTimeout = setTimeout(async () => {
    retryCount++;
    try {
      const snapshot = await plantsRef().orderBy('createdAt', 'asc').get();
      plants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      hideError();
      isLoading = false;
      retryCount = 0;
      render();
    } catch (err) {
      console.error('Retry failed:', err);
      retryLoad();
    }
  }, delays[retryCount]);
}

async function addPlant(name, environment) {
  const trimmed = name.trim();
  if (!trimmed) return;
  const docData = {
    name: trimmed,
    environment,
    lastWatered: null,
    customInterval: null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try {
    const docRef = await plantsRef().add(docData);
    plants.push({ id: docRef.id, ...docData, createdAt: new Date() });
    render();
  } catch (err) {
    console.error('Failed to add plant:', err);
    showError();
  }
}

async function waterPlant(plantId) {
  const plant = plants.find(p => p.id === plantId);
  if (!plant) return;
  const previousLastWatered = plant.lastWatered;
  const now = new Date();
  const newTimestamp = firebase.firestore.Timestamp.fromDate(now);
  // Optimistic UI update
  plant.lastWatered = newTimestamp;
  render();
  try {
    await plantsRef().doc(plantId).update({ lastWatered: newTimestamp });
    showUndoToast(`Watered ${plant.name}`, async () => {
      // Revert to previous value
      const revertValue = previousLastWatered || null;
      plant.lastWatered = revertValue;
      render();
      try {
        await plantsRef().doc(plantId).update({
          lastWatered: revertValue
        });
      } catch (err) {
        console.error('Failed to undo watering:', err);
        showError();
      }
    });
  } catch (err) {
    // Revert optimistic update on failure
    plant.lastWatered = previousLastWatered;
    render();
    console.error('Failed to water plant:', err);
    showError();
  }
}

async function deletePlant(plantId) {
  try {
    await plantsRef().doc(plantId).delete();
    plants = plants.filter(p => p.id !== plantId);
    if (expandedPlantId === plantId) expandedPlantId = null;
    render();
  } catch (err) {
    console.error('Failed to delete plant:', err);
    showError();
  }
}

async function updateCustomInterval(plantId, interval) {
  const val = interval === null ? null : Number(interval);
  try {
    await plantsRef().doc(plantId).update({ customInterval: val });
    const plant = plants.find(p => p.id === plantId);
    if (plant) {
      plant.customInterval = val;
      render();
    }
  } catch (err) {
    console.error('Failed to update interval:', err);
    showError();
  }
}

async function waterAllPlants() {
  const now = new Date();
  const ts = firebase.firestore.Timestamp.fromDate(now);
  // Save previous values for undo
  const previousValues = plants.map(p => ({ id: p.id, lastWatered: p.lastWatered }));
  // Optimistic UI update
  plants.forEach(p => { p.lastWatered = ts; });
  render();
  try {
    const batch = db.batch();
    plants.forEach(p => {
      batch.update(plantsRef().doc(p.id), { lastWatered: ts });
    });
    await batch.commit();
    showUndoToast('Watered all plants', async () => {
      // Revert all plants to previous values
      previousValues.forEach(prev => {
        const plant = plants.find(p => p.id === prev.id);
        if (plant) plant.lastWatered = prev.lastWatered;
      });
      render();
      try {
        const revertBatch = db.batch();
        previousValues.forEach(prev => {
          revertBatch.update(plantsRef().doc(prev.id), {
            lastWatered: prev.lastWatered || null
          });
        });
        await revertBatch.commit();
      } catch (err) {
        console.error('Failed to undo water all:', err);
        showError();
      }
    });
  } catch (err) {
    // Revert optimistic update on failure
    previousValues.forEach(prev => {
      const plant = plants.find(p => p.id === prev.id);
      if (plant) plant.lastWatered = prev.lastWatered;
    });
    render();
    console.error('Failed to water all plants:', err);
    showError();
  }
}

// ============================================================
// Plant Lookup Helpers
// ============================================================
function findPlantData(name) {
  return PLANT_DATABASE.find(p => p.name.toLowerCase() === name.toLowerCase()) || null;
}

function getInterval(plant) {
  if (plant.customInterval != null) {
    return [plant.customInterval, plant.customInterval];
  }
  const data = findPlantData(plant.name);
  if (data) {
    return plant.environment === 'outdoor' ? data.outdoor : data.indoor;
  }
  return plant.environment === 'outdoor' ? [5, 5] : [7, 7];
}

function getEmoji(name) {
  const data = findPlantData(name);
  return data ? data.emoji : '\ud83e\udeb4';
}

function getDaysSinceWatered(plant) {
  if (!plant.lastWatered) return null;
  const lastDate = plant.lastWatered.toDate ? plant.lastWatered.toDate() : new Date(plant.lastWatered);
  return Math.floor((Date.now() - lastDate.getTime()) / 86400000);
}

function getStatus(plant) {
  const days = getDaysSinceWatered(plant);
  if (days === null) return 'never';
  const [lower] = getInterval(plant);
  const urgencyPercent = (days / lower) * 100;
  if (urgencyPercent <= 50) return 'fresh';
  if (urgencyPercent <= 80) return 'close';
  if (urgencyPercent <= 100) return 'due';
  return 'overdue';
}

function getStatusText(status) {
  return STATUS_COLORS[status]?.label || 'Never watered';
}

function formatShortDate(date) {
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function getNextWaterDate(plant, lower) {
  if (!plant.lastWatered) return '‚Äî';
  const lastDate = plant.lastWatered.toDate ? plant.lastWatered.toDate() : new Date(plant.lastWatered);
  const nextDate = new Date(lastDate.getTime() + lower * 86400000);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  nextDate.setHours(0, 0, 0, 0);
  if (nextDate <= today) return 'Now';
  return formatShortDate(nextDate);
}

// ============================================================
// Error Banner
// ============================================================
function showError() {
  document.getElementById('errorBanner').classList.add('visible');
}

function hideError() {
  document.getElementById('errorBanner').classList.remove('visible');
}

// ============================================================
// Rendering
// ============================================================
function renderSkeleton() {
  return `
    <div class="plant-list">
      ${[1, 2, 3, 4].map(() => `
        <div class="skeleton-row">
          <div class="skeleton-line icon"></div>
          <div class="skeleton-line title"></div>
          <div class="skeleton-line subtitle"></div>
          <div class="skeleton-line button"></div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderEmptyState() {
  return `
    <div class="empty-state">
      <span class="emoji">\ud83c\udf31</span>
      <h2>No plants yet</h2>
      <p>Add your first plant and start tracking your watering schedule!</p>
      <button class="submit-btn" style="max-width: 240px; margin: 0 auto;" onclick="openAddModal()">Add Your First Plant</button>
      <div style="margin-top:24px;">
        <a href="#" onclick="event.preventDefault(); startFresh();" style="color:var(--gray-300); font-size:13px; text-decoration:none;">Not your list? Start fresh</a>
      </div>
    </div>
  `;
}

function renderPlantRow(plant) {
  const days = getDaysSinceWatered(plant);
  const status = getStatus(plant);
  const colors = STATUS_COLORS[status];
  const [lower] = getInterval(plant);
  const emoji = getEmoji(plant.name);
  const isCustom = plant.customInterval != null;
  const isExpanded = expandedPlantId === plant.id;
  const plantData = findPlantData(plant.name);

  // Status text under plant name
  let statusText;
  if (days === null) {
    statusText = 'Never watered';
  } else if (days === 0) {
    statusText = 'Watered today';
  } else if (days === 1) {
    statusText = 'Watered 1 day ago';
  } else {
    statusText = `Watered ${days} days ago`;
  }

  // Last watered tile
  let lastWateredText = 'Never';
  let lastWateredGreen = false;
  if (days === 0) { lastWateredText = 'Today'; lastWateredGreen = true; }
  else if (days === 1) { lastWateredText = 'Yesterday'; lastWateredGreen = true; }
  else if (days !== null) { lastWateredText = `${days} days ago`; }

  const freqText = isCustom ? `Every ${plant.customInterval}d` : `Every ${lower}d`;
  const nextWaterText = getNextWaterDate(plant, lower);
  const lightText = plantData && plantData.light ? plantData.light : 'Medium';
  const tipText = plantData && plantData.tip ? plantData.tip : 'Water when the top inch of soil feels dry.';

  // Interval editor / recommendation row
  let recHtml;
  if (isCustom) {
    recHtml = `
      <div class="expand-rec" id="rec-${plant.id}">
        <span>Custom: every ${plant.customInterval} day${plant.customInterval !== 1 ? 's' : ''}</span>
        <button class="expand-edit-btn" onclick="event.stopPropagation(); openIntervalEditor('${plant.id}')" title="Edit interval">‚úèÔ∏è</button>
        <button class="reset-link" onclick="event.stopPropagation(); resetInterval('${plant.id}')">Reset</button>
      </div>
    `;
  } else {
    recHtml = `
      <div class="expand-rec" id="rec-${plant.id}">
        <button class="expand-edit-btn" onclick="event.stopPropagation(); openIntervalEditor('${plant.id}')" title="Customize interval">‚úèÔ∏è Customize interval</button>
      </div>
    `;
  }

  return `
    <div class="plant-card${isExpanded ? ' open' : ''}" id="row-${plant.id}">
      <div class="card-row" onclick="toggleExpand('${plant.id}')">
        <div class="plant-icon">${emoji}</div>
        <div class="plant-info">
          <div class="plant-name">${escapeHtml(plant.name)} <span class="badge" style="background:${colors.badgeBg}; color:${colors.text};">${colors.label}</span></div>
          <div class="plant-status" style="color:${colors.text};">${statusText}</div>
        </div>
        <button class="water-circle" onclick="event.stopPropagation(); waterPlant('${plant.id}')" title="Water plant" aria-label="Water ${escapeHtml(plant.name)}">üíß</button>
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </div>
      <div class="expand-panel" id="detail-${plant.id}">
        <div class="expand-inner">
          <div class="expand-title">Care details</div>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Last watered</div>
              <div class="detail-value${lastWateredGreen ? ' green' : ''}">${lastWateredText}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Frequency</div>
              <div class="detail-value">${freqText}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Light</div>
              <div class="detail-value">${lightText}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Next water</div>
              <div class="detail-value">${nextWaterText}</div>
            </div>
          </div>
          <div class="care-note"><strong>Tip:</strong> ${tipText}</div>
          <div class="expand-actions">
            ${recHtml}
            <div class="interval-editor" id="editor-${plant.id}">
              <span>Every</span>
              <input type="number" min="1" max="365" id="input-${plant.id}" value="${isCustom ? plant.customInterval : lower}" onclick="event.stopPropagation()">
              <span>days</span>
              <button class="save-btn" onclick="event.stopPropagation(); saveInterval('${plant.id}')">Save</button>
              <button class="cancel-btn" onclick="event.stopPropagation(); closeIntervalEditor('${plant.id}')">Cancel</button>
            </div>
            <button class="plant-delete" onclick="event.stopPropagation(); confirmDelete('${plant.id}', '${escapeHtml(plant.name)}')" title="Remove plant">üóë Remove</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function render() {
  const app = document.getElementById('app');
  if (isLoading) {
    app.innerHTML = renderSkeleton();
    return;
  }
  if (plants.length === 0) {
    app.innerHTML = renderEmptyState();
    return;
  }
  app.innerHTML = `
    <div class="plant-list">
      <button class="water-all-btn" onclick="confirmWaterAll()">üíß Water All</button>
      ${plants.map(renderPlantRow).join('')}
      <button class="add-plant-btn" onclick="openAddModal()">+ Add a Plant</button>
      <div style="text-align:center; margin-top:24px;">
        <a href="#" onclick="event.preventDefault(); startFresh();" style="color:var(--gray-300); font-size:13px; text-decoration:none;">Start fresh</a>
      </div>
    </div>
  `;
}

function toggleExpand(plantId) {
  if (expandedPlantId === plantId) {
    expandedPlantId = null;
  } else {
    // Collapse previous
    if (expandedPlantId) {
      const prevCard = document.getElementById('row-' + expandedPlantId);
      if (prevCard) prevCard.classList.remove('open');
    }
    expandedPlantId = plantId;
  }
  const card = document.getElementById('row-' + plantId);
  if (card) {
    card.classList.toggle('open', expandedPlantId === plantId);
  }
}

function confirmWaterAll() {
  if (plants.length === 0) return;
  deleteTargetId = null;
  document.getElementById('confirmText').textContent = `Water all ${plants.length} plant${plants.length !== 1 ? 's' : ''}?`;
  document.querySelector('.confirm-box h3').textContent = 'Water all plants?';
  document.getElementById('confirmDelete').textContent = 'Water All';
  document.getElementById('confirmDelete').style.background = 'var(--accent)';
  document.getElementById('confirmDelete').onclick = async () => {
    await waterAllPlants();
    closeConfirmDialog();
  };
  confirmOverlay.classList.add('visible');
}

function closeConfirmDialog() {
  confirmOverlay.classList.remove('visible');
  // Reset dialog to defaults for delete usage
  document.querySelector('.confirm-box h3').textContent = 'Remove plant?';
  document.getElementById('confirmDelete').textContent = 'Remove';
  document.getElementById('confirmDelete').style.background = '';
  document.getElementById('confirmDelete').onclick = async () => {
    if (deleteTargetId) {
      await deletePlant(deleteTargetId);
      deleteTargetId = null;
      confirmOverlay.classList.remove('visible');
    }
  };
}

// ============================================================
// Interval Editing
// ============================================================
function openIntervalEditor(plantId) {
  const rec = document.getElementById(`rec-${plantId}`);
  const editor = document.getElementById(`editor-${plantId}`);
  if (rec) rec.style.display = 'none';
  if (editor) editor.classList.add('active');
  const input = document.getElementById(`input-${plantId}`);
  if (input) { input.focus(); input.select(); }
}

function closeIntervalEditor(plantId) {
  const rec = document.getElementById(`rec-${plantId}`);
  const editor = document.getElementById(`editor-${plantId}`);
  if (rec) rec.style.display = '';
  if (editor) editor.classList.remove('active');
}

function saveInterval(plantId) {
  const input = document.getElementById(`input-${plantId}`);
  const val = parseInt(input.value, 10);
  if (val > 0 && val <= 365) {
    updateCustomInterval(plantId, val);
  }
  closeIntervalEditor(plantId);
}

function resetInterval(plantId) {
  updateCustomInterval(plantId, null);
}

// ============================================================
// Add Plant Modal
// ============================================================
const addModal = document.getElementById('addModal');
const plantNameInput = document.getElementById('plantName');
const autocompleteList = document.getElementById('autocompleteList');
const addPlantSubmit = document.getElementById('addPlantSubmit');
const toggleIndoor = document.getElementById('toggleIndoor');
const toggleOutdoor = document.getElementById('toggleOutdoor');

function openAddModal() {
  plantNameInput.value = '';
  selectedEnv = 'indoor';
  toggleIndoor.classList.add('active');
  toggleOutdoor.classList.remove('active');
  addPlantSubmit.disabled = true;
  autocompleteList.classList.remove('visible');
  highlightedIndex = -1;
  addModal.classList.add('visible');
  setTimeout(() => plantNameInput.focus(), 100);
}

function closeAddModal() {
  addModal.classList.remove('visible');
  autocompleteList.classList.remove('visible');
  highlightedIndex = -1;
}

document.getElementById('modalClose').addEventListener('click', closeAddModal);

addModal.addEventListener('click', (e) => {
  if (e.target === addModal) closeAddModal();
});

toggleIndoor.addEventListener('click', () => {
  selectedEnv = 'indoor';
  toggleIndoor.classList.add('active');
  toggleOutdoor.classList.remove('active');
});

toggleOutdoor.addEventListener('click', () => {
  selectedEnv = 'outdoor';
  toggleOutdoor.classList.add('active');
  toggleIndoor.classList.remove('active');
});

plantNameInput.addEventListener('input', () => {
  const val = plantNameInput.value.trim();
  addPlantSubmit.disabled = val.length === 0;
  highlightedIndex = -1;
  if (val.length === 0) {
    autocompleteList.classList.remove('visible');
    return;
  }
  const matches = PLANT_DATABASE.filter(p => p.name.toLowerCase().includes(val.toLowerCase()));
  if (matches.length === 0) {
    autocompleteList.classList.remove('visible');
    return;
  }
  autocompleteList.innerHTML = matches.map((p, i) => `
    <div class="autocomplete-item" data-name="${escapeHtml(p.name)}" data-index="${i}">
      <span class="ac-emoji">${p.emoji}</span>
      <span class="ac-name">${escapeHtml(p.name)}</span>
      <span class="ac-interval">${selectedEnv === 'outdoor' ? p.outdoor[0] : p.indoor[0]}d</span>
    </div>
  `).join('');
  autocompleteList.classList.add('visible');

  autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', () => {
      plantNameInput.value = item.dataset.name;
      addPlantSubmit.disabled = false;
      autocompleteList.classList.remove('visible');
      highlightedIndex = -1;
    });
  });
});

plantNameInput.addEventListener('keydown', (e) => {
  const items = autocompleteList.querySelectorAll('.autocomplete-item');
  if (!autocompleteList.classList.contains('visible') || items.length === 0) {
    if (e.key === 'Enter' && !addPlantSubmit.disabled) {
      e.preventDefault();
      submitPlant();
    }
    return;
  }
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
    updateHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    highlightedIndex = Math.max(highlightedIndex - 1, -1);
    updateHighlight(items);
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (highlightedIndex >= 0 && highlightedIndex < items.length) {
      plantNameInput.value = items[highlightedIndex].dataset.name;
      addPlantSubmit.disabled = false;
      autocompleteList.classList.remove('visible');
      highlightedIndex = -1;
    } else if (!addPlantSubmit.disabled) {
      submitPlant();
    }
  } else if (e.key === 'Escape') {
    autocompleteList.classList.remove('visible');
    highlightedIndex = -1;
  }
});

function updateHighlight(items) {
  items.forEach((item, i) => {
    item.classList.toggle('highlighted', i === highlightedIndex);
  });
  if (highlightedIndex >= 0 && items[highlightedIndex]) {
    items[highlightedIndex].scrollIntoView({ block: 'nearest' });
  }
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.autocomplete-wrapper')) {
    autocompleteList.classList.remove('visible');
    highlightedIndex = -1;
  }
});

addPlantSubmit.addEventListener('click', submitPlant);

async function submitPlant() {
  const name = plantNameInput.value.trim();
  if (!name) return;
  addPlantSubmit.disabled = true;
  await addPlant(name, selectedEnv);
  closeAddModal();
}

// ============================================================
// Delete Confirmation
// ============================================================
const confirmOverlay = document.getElementById('confirmOverlay');

function confirmDelete(plantId, plantName) {
  deleteTargetId = plantId;
  document.querySelector('.confirm-box h3').textContent = 'Remove plant?';
  document.getElementById('confirmText').textContent = `This will permanently remove "${plantName}".`;
  document.getElementById('confirmDelete').textContent = 'Remove';
  document.getElementById('confirmDelete').style.background = '';
  document.getElementById('confirmDelete').onclick = async () => {
    if (deleteTargetId) {
      await deletePlant(deleteTargetId);
      deleteTargetId = null;
      confirmOverlay.classList.remove('visible');
    }
  };
  confirmOverlay.classList.add('visible');
}

document.getElementById('confirmCancel').addEventListener('click', () => {
  deleteTargetId = null;
  closeConfirmDialog();
});

document.getElementById('confirmDelete').addEventListener('click', async () => {
  if (deleteTargetId) {
    await deletePlant(deleteTargetId);
    deleteTargetId = null;
    confirmOverlay.classList.remove('visible');
  }
});

confirmOverlay.addEventListener('click', (e) => {
  if (e.target === confirmOverlay) {
    deleteTargetId = null;
    closeConfirmDialog();
  }
});

// ============================================================
// Undo Toast
// ============================================================
function showUndoToast(message, onUndo) {
  const toast = document.getElementById('undoToast');
  const bar = document.getElementById('undoToastBar');

  // If a toast is already showing, commit that action (no undo) and clear it
  if (undoToastTimeout) {
    clearTimeout(undoToastTimeout);
    undoToastTimeout = null;
    undoCallback = null;
  }

  document.getElementById('undoToastText').textContent = message;
  undoCallback = onUndo;

  // Reset the countdown bar animation
  toast.classList.remove('visible');
  bar.style.animation = 'none';
  // Force reflow to restart animation
  void bar.offsetWidth;
  bar.style.animation = '';
  toast.classList.add('visible');

  undoToastTimeout = setTimeout(() => {
    dismissUndoToast();
  }, 5000);
}

function dismissUndoToast() {
  const toast = document.getElementById('undoToast');
  toast.classList.remove('visible');
  if (undoToastTimeout) {
    clearTimeout(undoToastTimeout);
    undoToastTimeout = null;
  }
  undoCallback = null;
}

async function handleUndo() {
  if (!undoCallback) return;
  const cb = undoCallback;
  // Clear toast immediately
  const toast = document.getElementById('undoToast');
  toast.classList.remove('visible');
  if (undoToastTimeout) {
    clearTimeout(undoToastTimeout);
    undoToastTimeout = null;
  }
  undoCallback = null;
  await cb();
}

document.getElementById('undoToastBtn').addEventListener('click', handleUndo);

// ============================================================
// Utility
// ============================================================
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================================
// Initialize
// ============================================================
initUid();
loadPlants();
</script>
</body>
</html>
